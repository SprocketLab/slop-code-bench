---
id: chained-comparison-opportunity
language: python
severity: warning
message: Use chained comparison (e.g., a < b < c) instead of 'and'
metadata:
  weight: 1
  category: complexity
rule:
  kind: boolean_operator
  any:
  - pattern: $A < $B and $B < $C
  - pattern: $A > $B and $B > $C
  - pattern: $A <= $B and $B <= $C
  - pattern: $A >= $B and $B >= $C
  - pattern: $A < $B and $B <= $C
  - pattern: $A <= $B and $B < $C
  - pattern: $A > $B and $B >= $C
  - pattern: $A >= $B and $B > $C
---
id: chained-dict-get
language: python
severity: warning
message: Chained .get().get() - overly defensive, extract to helper
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  has:
    kind: attribute
    has:
      kind: call
      has:
        kind: attribute
        regex: "\\.get$"
    regex: "\\.get$"
---
id: comprehension-used-but-ignored-result
language: python
severity: warning
message: Comprehension result is never used - this looks like a side-effect-only comprehension
metadata:
  weight: 3
  category: complexity
rule:
  kind: expression_statement
  has:
    any:
    - kind: list_comprehension
    - kind: set_comprehension
    - kind: dictionary_comprehension
    - kind: generator_expression
---
id: constant-condition-if
language: python
severity: warning
message: Constant condition in if - dead code or unnecessary branching
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  any:
  - pattern: 'if True: $$$'
  - pattern: 'if False: $$$'
  - pattern: 'if None: $$$'
  - pattern: 'if 0: $$$'
  - pattern: 'if 1: $$$'
---
id: continue-in-else
language: python
severity: warning
message: continue in else branch - can often be simplified
metadata:
  weight: 1
  category: complexity
rule:
  kind: continue_statement
  inside:
    kind: else_clause
---
id: deeply-nested-try
language: python
severity: warning
message: Try-except with deep nesting - excessive complexity
metadata:
  weight: 3
  category: complexity
rule:
  kind: try_statement
  inside:
    any:
    - kind: for_statement
    - kind: while_statement
    - kind: if_statement
    inside:
      any:
      - kind: for_statement
      - kind: while_statement
      - kind: if_statement
---
id: double-negation
language: python
severity: warning
message: Double negation - can be simplified
metadata:
  weight: 1
  category: complexity
rule:
  kind: not_operator
  has:
    kind: not_operator
---
id: duplicated-if-condition
language: python
severity: warning
message: Duplicated if condition in elif chain
metadata:
  weight: 3
  category: complexity
rule:
  kind: if_statement
  pattern: "if $COND:\n  $$$\nelif $COND:\n  $$$\n"
---
id: excessive-nested-loops
language: python
severity: warning
message: Triple nested loops - O(n^3) complexity, consider refactoring
metadata:
  weight: 4
  category: complexity
rule:
  kind: for_statement
  has:
    kind: block
    has:
      kind: for_statement
      has:
        kind: block
        has:
          kind: for_statement
---
id: function-too-many-args
language: python
severity: warning
message: Function with 8+ arguments - consider using a data object
metadata:
  weight: 3
  category: complexity
rule:
  kind: function_definition
  has:
    kind: parameters
    has:
      nthChild:
        position: 8
---
id: isinstance-chain
language: python
severity: warning
message: Multiple isinstance checks - consider using isinstance with tuple
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  has:
    kind: elif_clause
    has:
      kind: call
      regex: "isinstance"
---
id: isinstance-return-ladder
language: python
severity: warning
message: Long isinstance/elif ladder returning simple values; prefer a dispatch table
  or polymorphism.
metadata:
  weight: 2
  category: complexity
rule:
  pattern: "if isinstance($X, $T1):\n  return $V1\nelif isinstance($X, $T2):\n  return\
    \ $V2\n"
---
id: manual-min-max
language: python
severity: warning
message: Manual min/max logic - use built-in min() or max()
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  any:
  - pattern: "if $A > $B:\n  $M = $A\nelse:\n  $M = $B\n"
  - pattern: "if $A < $B:\n  $M = $A\nelse:\n  $M = $B\n"
  - pattern: "if $A >= $B:\n  $M = $A\nelse:\n  $M = $B\n"
  - pattern: "if $A <= $B:\n  $M = $A\nelse:\n  $M = $B\n"
---
id: manual-str-join
language: python
severity: warning
message: Augmented assignment in loop - if building a string, use ''.join()
metadata:
  weight: 3
  category: complexity
rule:
  kind: for_statement
  has:
    kind: block
    has:
      kind: expression_statement
      has:
        kind: augmented_assignment
        pattern: $S += $X
---
id: multiple-context-managers-nested
language: python
severity: warning
message: Nested with statements - use 'with A, B' syntax
metadata:
  weight: 2
  category: complexity
rule:
  kind: with_statement
  has:
    kind: block
    has:
      kind: with_statement
---
id: nested-dict-comprehension
language: python
severity: warning
message: Nested dict/list comprehension - may be hard to read
metadata:
  weight: 3
  category: complexity
rule:
  kind: dictionary_comprehension
  has:
    any:
    - kind: dictionary_comprehension
    - kind: list_comprehension
---
id: nested-function-definition
language: python
severity: warning
message: Nested function definition - often unnecessary closure
metadata:
  weight: 2
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      kind: function_definition
---
id: nested-if-no-else
language: python
severity: warning
message: Nested if statements without else - consider flattening or combining conditions
metadata:
  weight: 4
  category: complexity
rule:
  kind: if_statement
  has:
    kind: block
    has:
      kind: if_statement
      not:
        has:
          kind: else_clause
---
id: nested-if-same-var
language: python
severity: warning
message: Nested if checking same variable - consider combining conditions
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  pattern: "if $COND:\n  if $COND:\n    $$$\n"
---
id: nested-ternary
language: python
severity: warning
message: Nested ternary expression - use if/elif/else for clarity
metadata:
  weight: 3
  category: complexity
rule:
  kind: conditional_expression
  has:
    kind: conditional_expression
---
id: pointless-lambda-call
language: python
severity: warning
message: Immediately called lambda - just execute the code
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  has:
    kind: parenthesized_expression
    has:
      kind: lambda
---
id: redundant-assignment-before-return
language: python
severity: warning
message: Assigning to variable just to return it - return directly
metadata:
  weight: 1
  category: complexity
rule:
  pattern: $VAR = $VAL
  precedes:
    pattern: return $VAR
---
id: repeated-dict-key-assignment
language: python
severity: warning
message: Repeated dict[key] = func(...) pattern - consider loop or dict comprehension
metadata:
  weight: 3
  category: complexity
rule:
  kind: expression_statement
  has:
    kind: assignment
    pattern: $DICT[$KEY] = $FUNC($$$)
  follows:
    kind: expression_statement
    has:
      kind: assignment
      pattern: $DICT[$KEY2] = $FUNC($$$)
---
id: repeated-if-continue
language: python
severity: warning
message: Multiple if-continue guards - consider list comprehension or filter function
metadata:
  weight: 2
  category: complexity
rule:
  kind: for_statement
  has:
    kind: block
    has:
      kind: if_statement
      has:
        kind: block
        has:
          kind: continue_statement
      follows:
        kind: if_statement
        has:
          kind: block
          has:
            kind: continue_statement
---
id: repeated-if-return-error
language: python
severity: warning
message: Multiple if-return error checks - consolidate validation logic
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  has:
    kind: block
    has:
      kind: return_statement
      regex: "error|Error|ERROR"
  follows:
    kind: if_statement
    has:
      kind: block
      has:
        kind: return_statement
        regex: "error|Error|ERROR"
---
id: repeated-try-except
language: python
severity: warning
message: Sequential try/except blocks - consolidate error handling
metadata:
  weight: 2
  category: complexity
rule:
  kind: try_statement
  follows:
    kind: try_statement
---
id: repeated-validation-calls
language: python
severity: warning
message: Repeated validation function calls - consider data-driven validation
metadata:
  weight: 2
  category: complexity
rule:
  kind: expression_statement
  has:
    kind: call
    regex: "^validate_"
  follows:
    kind: expression_statement
    has:
      kind: call
      regex: "^validate_"
---
id: superfluous-else-continue
language: python
severity: warning
message: 'else: continue at end of loop - redundant'
metadata:
  weight: 1
  category: complexity
rule:
  kind: if_statement
  has:
    kind: else_clause
    has:
      kind: block
      pattern: continue
---
id: ternary-same-value
language: python
severity: warning
message: Ternary returns same value for both branches - remove condition
metadata:
  weight: 3
  category: complexity
rule:
  kind: conditional_expression
  pattern: $VALUE if $COND else $VALUE
---
id: too-many-returns
language: python
severity: warning
message: Function with 6+ return statements - hard to reason about control flow
metadata:
  weight: 3
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      kind: return_statement
      nthChild:
        position: 6
---
id: triple-nested-if
language: python
severity: warning
message: Triple nested if - flatten or extract function
metadata:
  weight: 4
  category: complexity
rule:
  kind: if_statement
  has:
    kind: block
    has:
      kind: if_statement
      has:
        kind: block
        has:
          kind: if_statement
---
id: triple-or-condition
language: python
severity: warning
message: Triple OR condition - may indicate need for membership test
metadata:
  weight: 2
  category: complexity
rule:
  kind: boolean_operator
  pattern: $A or $B or $C
---
id: repeated-function-or-chain
language: python
severity: warning
message: "Same function called 4+ times with 'or' - use any(func(x) for x in [...])"
metadata:
  weight: 3
  category: complexity
rule:
  kind: boolean_operator
  pattern: $F($$$A) or $F($$$B) or $F($$$C) or $F($$$D)
---
id: type-check-instead-of-isinstance
language: python
severity: warning
message: type(x) is T - use isinstance(x, T) to support inheritance
metadata:
  weight: 2
  category: complexity
rule:
  kind: comparison_operator
  pattern: type($X) is $T
---
id: useless-try-except
language: python
severity: warning
message: Useless try-except - re-raising the exception without handling it
metadata:
  weight: 2
  category: complexity
rule:
  kind: try_statement
  has:
    kind: except_clause
    has:
      kind: block
      all:
      - has:
          kind: raise_statement
          regex: "^raise$"
      - not:
          has:
            kind: expression_statement
---
id: value-compare-return-ladder
language: python
severity: warning
message: Long value comparison ladder returning literals; prefer a dispatch map or
  dict lookup with a default.
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  pattern: "if $X == $V1:\n  return $R1\nelif $X == $V2:\n  return $R2\nelif $X ==\
    \ $V3:\n  return $R3\n"
  not:
    has:
      kind: else_clause
---
id: while-true-break
language: python
severity: warning
message: 'while True with break - consider restructuring loop condition'
metadata:
  weight: 2
  category: complexity
rule:
  kind: while_statement
  pattern: "while True:\n  $$$"
  has:
    kind: break_statement
---
id: return-in-finally
language: python
severity: warning
message: Returning inside finally can swallow real errors and hides control flow
metadata:
  weight: 4
  category: complexity
rule:
  pattern: |
    try:
      $$$
    finally:
      return $VAL
---
id: attribute-chain-depth-four
language: python
severity: warning
message: Attribute chain 4+ deep is hard to read - break it up
metadata:
  weight: 2
  category: complexity
rule:
  kind: attribute
  has:
    kind: attribute
    has:
      kind: attribute
      has:
        kind: attribute
---
id: redundant-else-after-exit
language: python
severity: warning
message: else after return/raise is redundant - remove unnecessary indentation
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  any:
  - pattern: |
      if $COND:
        return $VAL
      else:
        $$$
  - pattern: |
      if $COND:
        raise $E
      else:
        $$$
---
id: while-true-pass
language: python
severity: warning
message: Infinite while True with pass - busy loop with no exit
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    while True:
      pass
---
id: dynamic-code-execution
language: python
severity: warning
message: exec/eval usage is opaque and risky - avoid dynamic code execution
metadata:
  weight: 4
  category: complexity
rule:
  kind: call
  any:
  - pattern: exec($$$)
  - pattern: eval($$$)
---
id: global-statement
language: python
severity: warning
message: global statements hide dependencies and state coupling
metadata:
  weight: 3
  category: complexity
rule:
  kind: global_statement
---
id: nonlocal-anywhere
language: python
severity: warning
message: nonlocal usage tangles scopes - prefer explicit parameters
metadata:
  weight: 2
  category: complexity
rule:
  kind: nonlocal_statement
---
id: boolean-chain-four-and
language: python
severity: warning
message: Boolean chain with 4+ terms - consider extracting to helper or variable
metadata:
  weight: 2
  category: complexity
rule:
  kind: boolean_operator
  pattern: $A and $B and $C and $D
---
id: print-in-except
language: python
severity: warning
message: Printing in except instead of handling/raising hides failures
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except $E:
      print($$)
---
id: assert-false-sentinel
language: python
severity: warning
message: assert False used as a control gate is opaque; use explicit errors
metadata:
  weight: 3
  category: complexity
rule:
  pattern: assert False
---
id: raise-generic-exception
language: python
severity: warning
message: Raising raw Exception loses specificity and debugging context
metadata:
  weight: 2
  category: complexity
rule:
  pattern: raise Exception($$)
---
id: equality-or-chain-four
language: python
severity: warning
message: Long equality OR chain - use membership checks or dispatch maps
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    if $X == $A or $X == $B or $X == $C or $X == $D:
      $$$
---
id: state-ladder
language: python
severity: warning
message: State comparison ladder - consider using enum/dispatch pattern
metadata:
  weight: 3
  category: complexity
rule:
  kind: if_statement
  pattern: |
    if $STATE == $S1:
      $$$
    elif $STATE == $S2:
      $$$
    elif $STATE == $S3:
      $$$
---
id: repetitive-list-append-elif
language: python
severity: warning
message: Appending to the same list across elifs reads like copy/paste - refactor
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    if $C1:
      $L.append($A)
    elif $C2:
      $L.append($B)
    elif $C3:
      $L.append($C)
---
id: while-true-sleep
language: python
severity: warning
message: Polling loop with time.sleep in while True is brittle; add exit conditions
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    while True:
      $$$
      time.sleep($$)
---
id: import-inside-function
language: python
severity: warning
message: Imports inside functions hide dependencies and reload modules repeatedly
metadata:
  weight: 2
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      any:
      - kind: import_statement
      - kind: import_from_statement
---
id: bare-except-pass
language: python
severity: warning
message: Bare except with pass swallows every error - handle specific cases
metadata:
  weight: 4
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except:
      pass
---
id: broad-except-return-none
language: python
severity: warning
message: Returning None from a broad except hides the real failure
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except Exception:
      return None
---
id: monolithic-module
language: python
severity: warning
message: File with 200+ top-level statements - split into modules
metadata:
  weight: 5
  category: complexity
rule:
  kind: module
  has:
    nthChild:
      position: 200
---
id: oversized-function-body
language: python
severity: warning
message: Function with 40+ statements is hard to follow - extract helpers
metadata:
  weight: 4
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      nthChild:
        position: 40
---
id: class-too-many-members
language: python
severity: warning
message: Class with 25+ members becomes an unreadable God object
metadata:
  weight: 4
  category: complexity
rule:
  kind: class_definition
  has:
    kind: block
    has:
      nthChild:
        position: 25
---
id: five-elif-ladder
language: python
severity: warning
message: Long elif ladder - use a dispatch dict or map for clarity
metadata:
  weight: 3
  category: complexity
rule:
  kind: if_statement
  has:
    kind: elif_clause
    nthChild:
      position: 4
---
id: args-kwargs-only-signature
language: python
severity: warning
message: Signature of only *args/**kwargs hides the expected inputs
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    def $F(*args, **kwargs):
      $$$
---
id: manual-path-concat
language: python
severity: warning
message: Manual string path concatenation - use pathlib or os.path.join
metadata:
  weight: 2
  category: complexity
rule:
  kind: binary_operator
  regex: "\\+\\s*[\"']/[\"']\\s*\\+"
---
id: multiple-flag-parameters
language: python
severity: warning
message: Function with multiple boolean flag parameters - unclear responsibilities
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    def $F($A=False, $B=False, $C=False):
      $$$
---
id: nested-try-in-except
language: python
severity: warning
message: try inside an except makes control flow opaque - refactor error handling
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except $E:
      try:
        $$$
      except $F:
        $$$
---
id: lambda-nested-ternary
language: python
severity: warning
message: Lambda containing a ternary is dense; use a named function
metadata:
  weight: 2
  category: complexity
rule:
  kind: lambda
  has:
    kind: conditional_expression
---
id: class-defined-in-function
language: python
severity: warning
message: Defining classes inside functions obscures reuse - move to module scope
metadata:
  weight: 2
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      kind: class_definition
---
id: import-inside-loop
language: python
severity: warning
message: Imports inside loops add hidden side effects and slow iterations
metadata:
  weight: 2
  category: complexity
rule:
  kind: for_statement
  has:
    kind: block
    has:
      any:
      - kind: import_statement
      - kind: import_from_statement
---
id: reraise-same-exception
language: python
severity: warning
message: Re-raising the caught exception object drops traceback; use bare raise
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except Exception as $E:
      raise $E
---
id: try-else-pass
language: python
severity: warning
message: try/else with a pass else block is needless nesting noise
metadata:
  weight: 1
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except $E:
      $$$
    else:
      pass
---
id: try-finally-pass
language: python
severity: warning
message: try/finally with pass in finally hides missing cleanup
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    try:
      $$$
    finally:
      pass
---
id: for-range-len
language: python
severity: warning
message: range(len(seq)) loop suggests index juggling; prefer enumerate
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    for $I in range(len($SEQ)):
      $$$
---
id: catch-baseexception
language: python
severity: warning
message: Catching BaseException traps system exits and interrupts
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except BaseException:
      $$$
---
id: while-true-continue
language: python
severity: warning
message: while True with only continue is an infinite spin loop
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    while True:
      continue
---
id: lambda-assigned-then-called
language: python
severity: warning
message: Assigning a lambda then immediately calling it is needless indirection
metadata:
  weight: 2
  category: complexity
rule:
  kind: expression_statement
  pattern: $F($$CALL_ARGS)
  follows:
    kind: expression_statement
    pattern: "$F = lambda $$ARGS: $BODY"
---
id: except-exception-return-literal
language: python
severity: warning
message: Returning a literal from broad except masks the real failure
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except Exception:
      return $LIT
---
id: double-while-true
language: python
severity: warning
message: Nested while True loops are opaque and likely runaway control flow
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    while True:
      while True:
        $$$
---
id: time-sleep-in-loop
language: python
severity: warning
message: Repeated time.sleep inside loop signals polling slop; consider event-driven
metadata:
  weight: 2
  category: complexity
rule:
  kind: for_statement
  has:
    kind: block
    has:
      kind: call
      regex: "time\\.sleep"
---
id: deep-nested-with
language: python
severity: warning
message: Four-level nested with statements are dense; combine or extract helpers
metadata:
  weight: 3
  category: complexity
rule:
  kind: with_statement
  has:
    kind: block
    has:
      kind: with_statement
      has:
        kind: block
        has:
          kind: with_statement
          has:
            kind: block
            has:
              kind: with_statement
---
id: boolean-return-if-else
language: python
severity: warning
message: if/else returning True/False - simplify to return the condition directly
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  any:
  - pattern: |
      if $COND:
        return True
      else:
        return False
  - pattern: |
      if $COND:
        return False
      else:
        return True
---
id: list-map-lambda
language: python
severity: warning
message: list(map(lambda ...)) is noisier than a list comprehension
metadata:
  weight: 2
  category: complexity
rule:
  pattern: "list(map(lambda $$ARGS: $BODY, $ITER))"
---
id: map-filter-lambda
language: python
severity: warning
message: Combining map and filter lambdas reads like a pipeline of indirection
metadata:
  weight: 2
  category: complexity
rule:
  pattern: "list(map($F, filter($G, $ITER)))"
---
id: chained-str-replace
language: python
severity: warning
message: Multiple sequential .replace calls are brittle; use a small helper
metadata:
  weight: 2
  category: complexity
rule:
  pattern: $S.replace($$ARGS1).replace($$ARGS2)
---
id: json-dumps-then-loads
language: python
severity: warning
message: json.loads(json.dumps(x)) is noisy; copy the structure directly
metadata:
  weight: 2
  category: complexity
rule:
  pattern: json.loads(json.dumps($X))
---
id: nested-lambda
language: python
severity: warning
message: Lambda returning another lambda obscures behavior; use named functions
metadata:
  weight: 2
  category: complexity
rule:
  kind: lambda
  has:
    kind: lambda
---
id: lambda-default-argument
language: python
severity: warning
message: Default argument as a lambda is surprising implicit behavior
metadata:
  weight: 2
  category: complexity
rule:
  kind: function_definition
  has:
    kind: parameters
    has:
      kind: default_parameter
      has:
        kind: lambda
---
id: len-compare-redundant
language: python
severity: warning
message: len(x) compared to 0 - prefer truthiness check on the container
metadata:
  weight: 1
  category: complexity
rule:
  kind: if_statement
  any:
  - pattern: "if len($X) == 0:"
  - pattern: "if len($X) != 0:"
  - pattern: "if len($X) > 0:"
---
id: function-too-many-ifs
language: python
severity: warning
message: Function with 10+ if statements is a branchy maze
metadata:
  weight: 3
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      kind: if_statement
      nthChild:
        position: 10
---
id: function-too-many-continues
language: python
severity: warning
message: Function with 4+ continue statements hides intent
metadata:
  weight: 2
  category: complexity
rule:
  kind: function_definition
  has:
    kind: block
    has:
      kind: continue_statement
      nthChild:
        position: 4
---
id: chained-assignment
language: python
severity: warning
message: Chained assignment a = b = c obscures source of values
metadata:
  weight: 1
  category: complexity
rule:
  pattern: $A = $B = $C
---
id: log-and-swallow-exception
language: python
severity: warning
message: Logging an exception then continuing hides failures; re-raise or handle it
metadata:
  weight: 3
  category: complexity
rule:
  pattern: |
    try:
      $$$
    except Exception as $E:
      log.error($$)
---
id: call-too-many-positional-args
language: python
severity: warning
message: Call with 8+ positional args is hard to read; use kwargs or objects
metadata:
  weight: 3
  category: complexity
rule:
  kind: call
  has:
    kind: argument_list
    has:
      nthChild:
        position: 8
---
id: nested-conditional-in-call
language: python
severity: warning
message: Passing a ternary directly into a call makes it dense; split it out
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  has:
    kind: conditional_expression
---
id: pointless-bool-cast
language: python
severity: warning
message: Wrapping a condition in bool() before if is redundant ceremony
metadata:
  weight: 1
  category: complexity
rule:
  kind: if_statement
  pattern: |
    if bool($COND):
      $$$
---
id: list-filter-none
language: python
severity: warning
message: list(filter(None, ...)) obscures the predicate; use comprehension
metadata:
  weight: 2
  category: complexity
rule:
  pattern: list(filter(None, $ITER))
---
id: single-call-wrapper
language: python
severity: warning
message: "Function body is just 'return func(...)' - trivial wrapper adds indirection"
metadata:
  weight: 2
  category: complexity
rule:
  pattern: |
    def $NAME($$$ARGS):
      return $FUNC($$$CALL_ARGS)
---
id: immediate-builder-pattern
language: python
severity: warning
message: "Builder instantiated and .build() called in same expression - pattern adds ceremony without benefit"
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  has:
    kind: attribute
    regex: "\\.build$"
    has:
      kind: call
      has:
        kind: attribute
        has:
          kind: call
---
id: empty-abstract-base
language: python
severity: warning
message: "ABC class with no @abstractmethod - just a regular class with ABC inheritance"
metadata:
  weight: 2
  category: complexity
rule:
  kind: class_definition
  has:
    kind: argument_list
    has:
      kind: identifier
      regex: "^ABC$"
  not:
    has:
      kind: block
      has:
        kind: decorated_definition
        has:
          kind: decorator
          regex: "@abstractmethod"
---
id: env-based-branching
language: python
severity: warning
message: "Conditional on environment variable buried in logic - extract to config"
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  has:
    kind: call
    any:
      - pattern: os.environ.get($$$)
      - pattern: os.getenv($$$)
      - pattern: os.environ[$KEY]
---
id: silent-value-clamping
language: python
severity: warning
message: "Value clamping with min/max without logging - silently adjusts out-of-range values"
metadata:
  weight: 2
  category: complexity
rule:
  any:
    - pattern: max($A, min($B, $C))
    - pattern: min(max($A, $B), $C)
    - pattern: min($A, max($B, $C))
    - pattern: max(min($A, $B), $C)
---
id: decorator-chain-three-plus
language: python
severity: warning
message: "Function has 3+ decorators - consider composing into single decorator"
metadata:
  weight: 2
  category: complexity
rule:
  kind: decorated_definition
  has:
    kind: decorator
    nthChild:
      position: 3
---
id: consecutive-if-same-variable
language: python
severity: warning
message: "Consecutive if statements checking same variable - should use elif for efficiency"
metadata:
  weight: 3
  category: complexity
rule:
  kind: if_statement
  has:
    kind: comparison_operator
    has:
      kind: identifier
      pattern: $VAR
  follows:
    kind: if_statement
    all:
      - has:
          kind: comparison_operator
          has:
            kind: identifier
            pattern: $VAR
      - has:
          kind: block
          has:
            kind: return_statement
    stopBy: neighbor
---
id: excessive-method-chain
language: python
severity: warning
message: "Excessive method chaining (4+ calls) - extract intermediate variables for readability"
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  has:
    kind: attribute
    has:
      kind: call
      has:
        kind: attribute
        has:
          kind: call
          has:
            kind: attribute
            has:
              kind: call
---
id: nested-attribute-guard-chain
language: python
severity: warning
message: "Nested attribute guard chain (if x: if x.y: if x.y.z:) - use walrus operator or getattr"
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  all:
    - has:
        kind: identifier
        pattern: $OBJ
    - has:
        kind: block
        has:
          kind: if_statement
          all:
            - has:
                kind: attribute
                has:
                  kind: identifier
                  pattern: $OBJ
            - has:
                kind: block
                has:
                  kind: if_statement
---
id: repeated-isinstance-validation
language: python
severity: warning
message: "Repeated isinstance validation pattern - extract to validation helper or use schema"
metadata:
  weight: 2
  category: complexity
rule:
  kind: if_statement
  all:
    - has:
        kind: not_operator
        has:
          kind: call
          pattern: isinstance($VAR, $TYPE)
    - has:
        kind: block
        has:
          kind: raise_statement
  follows:
    kind: if_statement
    all:
      - has:
          kind: not_operator
          has:
            kind: call
            regex: "isinstance"
      - has:
          kind: block
          has:
            kind: raise_statement
    stopBy: neighbor
---
id: split-magic-index
language: python
severity: warning
message: "String split with magic index - extract to named variable or use unpacking"
metadata:
  weight: 2
  category: complexity
rule:
  kind: subscript
  all:
    - has:
        kind: call
        has:
          kind: attribute
          regex: "\\.split$"
    - has:
        kind: integer
        regex: "^[2-9]|[1-9][0-9]+$"
---
id: many-exception-types
language: python
severity: warning
message: "Catching 4+ exception types suggests overly broad error handling - consider restructuring"
metadata:
  weight: 3
  category: complexity
rule:
  kind: except_clause
  has:
    kind: tuple
    has:
      nthChild:
        position: 4
---
id: isinstance-or-chain-validation
language: python
severity: warning
message: "Chained isinstance checks with 'or not' - consider schema validation or type guards"
metadata:
  weight: 2
  category: complexity
rule:
  kind: boolean_operator
  regex: "not isinstance.*or.*not isinstance"
---
id: return-empty-collection-pair
language: python
severity: warning
message: "Returning pair of empty collections - consider returning a named tuple or dataclass"
metadata:
  weight: 2
  category: complexity
rule:
  kind: return_statement
  any:
    - pattern: return [], []
    - pattern: return {}, {}
    - pattern: return [], {}
    - pattern: return {}, []
---
id: ternary-none-comparison
language: python
severity: warning
message: "Ternary with None comparison - consider using 'or' operator or walrus"
metadata:
  weight: 2
  category: complexity
rule:
  kind: conditional_expression
  pattern: $VAL if $VAR is None else $OTHER
---
id: redundant-bool-in-condition
language: python
severity: warning
message: "Redundant bool() cast in condition - if already checks truthiness"
metadata:
  weight: 1
  category: complexity
rule:
  kind: if_statement
  has:
    kind: boolean_operator
    has:
      kind: call
      pattern: bool($X)
---
id: isinstance-dispatch-ladder
language: python
severity: warning
message: "Long isinstance dispatch ladder - use a dispatch dict or visitor pattern"
metadata:
  weight: 3
  category: complexity
rule:
  kind: if_statement
  all:
    - has:
        kind: call
        pattern: isinstance($X, $T1)
    - has:
        kind: block
        has:
          kind: return_statement
    - has:
        kind: elif_clause
        all:
          - has:
              kind: call
              pattern: isinstance($X, $T2)
          - has:
              kind: elif_clause
              all:
                - has:
                    kind: call
                    pattern: isinstance($X, $T3)
                - has:
                    kind: elif_clause
                    has:
                      kind: call
                      pattern: isinstance($X, $T4)
---
id: unbounded-lru-cache
language: python
severity: warning
message: "lru_cache(maxsize=None) can grow unbounded - consider a bounded cache"
metadata:
  weight: 2
  category: complexity
rule:
  kind: decorator
  any:
    - pattern: "@lru_cache(maxsize=None)"
    - pattern: "@functools.lru_cache(maxsize=None)"
---
id: next-generator-no-default
language: python
severity: warning
message: "next() on generator without default - raises StopIteration if empty"
metadata:
  weight: 3
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: identifier
        regex: "^next$"
    - has:
        kind: argument_list
        has:
          kind: generator_expression
        not:
          has:
            nthChild:
              position: 2
---
id: truncated-uuid
language: python
severity: warning
message: "Truncated UUID (hex[:N]) risks collisions - use full UUID or proper ID generation"
metadata:
  weight: 2
  category: complexity
rule:
  kind: subscript
  all:
    - has:
        kind: attribute
        pattern: $UUID.hex
    - has:
        kind: slice
---
id: deep-dict-access
language: python
severity: warning
message: "Deep nested dict access (4+ levels) - extract to helper or use dataclass"
metadata:
  weight: 2
  category: complexity
rule:
  kind: subscript
  has:
    kind: subscript
    has:
      kind: subscript
      has:
        kind: subscript
---
id: long-tuple-unpacking
language: python
severity: warning
message: "Unpacking 5+ values from tuple - use named tuple or dataclass"
metadata:
  weight: 2
  category: complexity
rule:
  kind: assignment
  has:
    kind: pattern_list
    has:
      nthChild:
        position: 5
---
id: repeated-string-concat-loop
language: python
severity: warning
message: "String concatenation with += in loop - use join() or list append"
metadata:
  weight: 3
  category: complexity
rule:
  kind: for_statement
  has:
    kind: block
    has:
      kind: augmented_assignment
      regex: "\\+="
      has:
        kind: string
---
id: fetchone-none-check
language: python
severity: hint
message: "cursor.fetchone() followed by None check - common pattern, consider helper"
metadata:
  weight: 1
  category: complexity
rule:
  kind: if_statement
  has:
    kind: comparison_operator
    regex: "is None"
  follows:
    kind: expression_statement
    has:
      kind: assignment
      has:
        kind: call
        has:
          kind: attribute
          regex: "\\.fetchone$"
    stopBy: neighbor
---
id: repeated-dict-subscript-access
language: python
severity: warning
message: "Same dict key accessed multiple times - extract to local variable"
metadata:
  weight: 2
  category: complexity
rule:
  kind: subscript
  pattern: $DICT[$KEY]
  follows:
    kind: subscript
    pattern: $DICT[$KEY]
    stopBy: neighbor
---
id: single-use-variable-return
language: python
severity: warning
message: "Single-use variable immediately returned - return the expression directly"
metadata:
  weight: 1
  category: complexity
rule:
  kind: return_statement
  has:
    kind: identifier
    pattern: $VAR
  follows:
    kind: expression_statement
    has:
      kind: assignment
      has:
        kind: identifier
        pattern: $VAR
    stopBy: neighbor
---
id: nested-ternary
language: python
severity: warning
message: "Nested ternary expression - extract to if/else or helper function for readability"
metadata:
  weight: 3
  category: complexity
rule:
  kind: conditional_expression
  any:
    - has:
        kind: conditional_expression
    - has:
        kind: parenthesized_expression
        has:
          kind: conditional_expression
---
id: hardcoded-sleep
language: python
severity: warning
message: "Hardcoded sleep value - use named constant or configuration"
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        pattern: time.sleep
    - has:
        kind: argument_list
        has:
          any:
            - kind: integer
            - kind: float
---
id: string-path-concat
language: python
severity: warning
message: "String concatenation for paths - use pathlib or os.path.join"
metadata:
  weight: 3
  category: complexity
rule:
  kind: binary_operator
  regex: "\\+"
  has:
    kind: string
    regex: "^['\"][\\\\/]['\"]$"
---
id: fillna-zero-default
language: python
severity: warning
message: "fillna(0) masks missing data - consider if 0 is semantically correct or use explicit sentinel"
metadata:
  weight: 3
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        regex: "\\.fillna$"
    - has:
        kind: argument_list
        has:
          kind: integer
          regex: "^0$"
---
id: fillna-empty-string-default
language: python
severity: warning
message: "fillna('') masks missing data - empty string hides NULL semantics"
metadata:
  weight: 3
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        regex: "\\.fillna$"
    - has:
        kind: argument_list
        has:
          kind: string
          regex: "^['\"]['\"]$"
---
id: dict-get-zero-default
language: python
severity: warning
message: "dict.get() with 0 default - consider if missing key should really be 0"
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        regex: "\\.get$"
    - has:
        kind: argument_list
        has:
          kind: integer
          regex: "^0$"
          nthChild:
            position: 2
---
id: dict-get-empty-string-default
language: python
severity: warning
message: "dict.get() with '' default - consider if missing key should really be empty string"
metadata:
  weight: 2
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        regex: "\\.get$"
    - has:
        kind: argument_list
        has:
          kind: string
          regex: "^['\"]['\"]$"
          nthChild:
            position: 2
---
id: dict-get-empty-list-default
language: python
severity: warning
message: "dict.get() with [] default - mutable default, use .setdefault() or defaultdict"
metadata:
  weight: 3
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        regex: "\\.get$"
    - has:
        kind: argument_list
        has:
          kind: list
          not:
            has:
              any:
                - kind: identifier
                - kind: integer
                - kind: string
          nthChild:
            position: 2
---
id: dict-get-empty-dict-default
language: python
severity: warning
message: "dict.get() with {} default - mutable default, use .setdefault() or defaultdict"
metadata:
  weight: 3
  category: complexity
rule:
  kind: call
  all:
    - has:
        kind: attribute
        regex: "\\.get$"
    - has:
        kind: argument_list
        has:
          kind: dictionary
          not:
            has:
              kind: pair
          nthChild:
            position: 2
---
id: too-many-optional-params
language: python
severity: warning
message: "Function has 3+ Optional parameters (= None) - consider builder pattern, config object, or overloads"
metadata:
  weight: 3
  category: complexity
rule:
  kind: function_definition
  has:
    kind: parameters
    regex: "(?s)= None.*= None.*= None"
