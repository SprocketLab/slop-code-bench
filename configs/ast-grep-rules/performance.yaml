---
id: check-key-in-dict-keys
language: python
severity: warning
message: Checking 'key in dict.keys()' - inefficient, use 'key in dict'
metadata:
  weight: 2
  category: performance
rule:
  kind: comparison_operator
  regex: "\\sin\\s"
  has:
    kind: call
    has:
      kind: attribute
      regex: "\\.keys$"
---
id: deepcopy-single-mutation
language: python
severity: warning
message: Deepcopy followed by a single attribute tweak; prefer shallow copy or direct
  construction.
metadata:
  weight: 3
  category: performance
rule:
  kind: expression_statement
  pattern: $NEW.$ATTR = $VAL
  follows:
    kind: expression_statement
    pattern: $NEW = copy.deepcopy($OBJ)
---
id: excessive-deepcopy
language: python
severity: warning
message: copy.deepcopy() detected - consider if shallow copy or direct construction
  would suffice
metadata:
  weight: 3
  category: performance
rule:
  kind: call
  has:
    kind: attribute
    regex: "\\.deepcopy$"
---
id: generator-into-list-then-first-element
language: python
severity: warning
message: Materializing generator just to index [0] - use next(...) instead
metadata:
  weight: 3
  category: performance
rule:
  kind: subscript
  all:
  - has:
      kind: call
      all:
      - has:
          kind: identifier
          regex: "^list$"
      - has:
          kind: generator_expression
  - has:
      kind: integer
      pattern: '0'
---
id: json-loads-read
language: python
severity: warning
message: json.loads(f.read()) - use json.load(f)
metadata:
  weight: 2
  category: performance
rule:
  kind: call
  has:
    kind: argument_list
    has:
      kind: call
      has:
        kind: attribute
        regex: "\\.read$"
---
id: json-roundtrip-dumps-loads
language: python
severity: warning
message: json.loads(json.dumps(obj)) round-trip without mutation is pointless; avoid
  double serialization.
metadata:
  weight: 3
  category: performance
rule:
  kind: call
  pattern: json.loads(json.dumps($OBJ))
---
id: list-comp-side-effect
language: python
severity: warning
message: List comprehension used only for side effects; use a loop instead of building
  an unused list.
metadata:
  weight: 2
  category: performance
rule:
  kind: expression_statement
  has:
    kind: list_comprehension
---
id: list-dict-keys
language: python
severity: warning
message: list(d.keys()) is verbose - use list(d) or iterate directly
metadata:
  weight: 2
  category: performance
rule:
  kind: call
  all:
  - has:
      kind: identifier
      regex: "^list$"
  - has:
      kind: argument_list
      has:
        kind: call
        has:
          kind: attribute
          regex: "\\.keys$"
---
id: logging-f-string
language: python
severity: warning
message: logging with f-string - use lazy formatting logging.info('%s', x)
metadata:
  weight: 2
  category: performance
rule:
  kind: call
  has:
    kind: argument_list
    has:
      kind: string
      regex: "^f['\"]"
  any:
  - has:
      kind: identifier
      regex: "^logging$"
  - has:
      kind: attribute
      regex: "\\.(debug|info|warning|error|exception|critical)$"
---
id: math-pow
language: python
severity: warning
message: math.pow(x, y) - use x ** y operator
metadata:
  weight: 2
  category: performance
rule:
  kind: call
  has:
    kind: attribute
    regex: "math\\.pow"
---
id: pandas-iterrows
language: python
severity: warning
message: Use of .iterrows() - highly inefficient, use vectorization or .itertuples()
metadata:
  weight: 4
  category: performance
rule:
  kind: call
  has:
    kind: attribute
    regex: "\\.iterrows$"
---
id: re-compile-in-function
language: python
severity: warning
message: re.compile() inside function - compile at module level to avoid recompilation
metadata:
  weight: 3
  category: performance
rule:
  kind: call
  has:
    kind: attribute
    regex: "re\\.compile"
  inside:
    kind: function_definition
---
id: repeated-method-call
language: python
severity: warning
message: Repeated method calls - consider loop or bulk operation
metadata:
  weight: 2
  category: performance
rule:
  kind: expression_statement
  has:
    kind: call
    has:
      kind: attribute
      regex: "\\.(append|add|update|extend|remove|pop)$"
  follows:
    kind: expression_statement
    has:
      kind: call
      has:
        kind: attribute
        regex: "\\.(append|add|update|extend|remove|pop)$"
---
id: listcomp-in-builtin-call
language: python
severity: warning
message: List comprehension in all/any/sum/set/dict call - use generator expression
  or comprehension for memory efficiency
metadata:
  weight: 2
  category: performance
rule:
  kind: call
  all:
  - has:
      kind: identifier
      regex: "^(all|any|sum|set|dict)$"
  - has:
      kind: argument_list
      has:
        kind: list_comprehension
---
id: unnecessary-list-call
language: python
severity: warning
message: Unnecessary list() around iterable in for loop
metadata:
  weight: 2
  category: performance
rule:
  kind: for_statement
  has:
    kind: call
    has:
      kind: identifier
      regex: "^list$"
---
id: sorted-first-last
language: python
severity: warning
message: "sorted(x)[0] or sorted(x)[-1] is O(n log n) - use min(x) or max(x) for O(n)"
metadata:
  weight: 3
  category: performance
rule:
  kind: subscript
  all:
  - has:
      kind: call
      has:
        kind: identifier
        regex: "^sorted$"
  - any:
    - has:
        kind: integer
        pattern: '0'
    - has:
        kind: unary_operator
        pattern: '-1'
---
id: len-as-condition
language: python
severity: warning
message: "Comparing len() to 0 is verbose - use truthiness 'if x:' or 'if not x:'"
metadata:
  weight: 2
  category: performance
rule:
  kind: comparison_operator
  all:
  - has:
      kind: call
      has:
        kind: identifier
        regex: "^len$"
  - has:
      kind: integer
      pattern: '0'
---
id: string-concat-in-loop
language: python
severity: warning
message: "String concatenation with += in loop is O(nÂ²) - consider ''.join()"
metadata:
  weight: 3
  category: performance
rule:
  kind: augmented_assignment
  regex: "\\+="
  has:
    kind: string
  inside:
    stopBy: end
    any:
    - kind: for_statement
    - kind: while_statement
---
id: open-without-context-manager
language: python
severity: warning
message: "open() without context manager risks resource leak - use 'with open(...) as f:'"
metadata:
  weight: 3
  category: performance
rule:
  all:
  - kind: call
    has:
      kind: identifier
      regex: "^open$"
  - not:
      inside:
        kind: with_statement
---
id: list-map-filter
language: python
severity: warning
message: "list(map(...)) or list(filter(...)) - consider list comprehension instead"
metadata:
  weight: 2
  category: performance
rule:
  kind: call
  all:
  - has:
      kind: identifier
      regex: "^list$"
  - has:
      kind: argument_list
      has:
        kind: call
        has:
          kind: identifier
          regex: "^(map|filter)$"
---
id: range-len-antipattern
language: python
severity: warning
message: "for i in range(len(x)) - use 'enumerate(x)' or iterate directly"
metadata:
  weight: 2
  category: performance
rule:
  kind: for_statement
  has:
    kind: call
    all:
    - has:
        kind: identifier
        regex: "^range$"
    - has:
        kind: argument_list
        has:
          kind: call
          has:
            kind: identifier
            regex: "^len$"
---
id: membership-test-list-literal
language: python
severity: warning
message: "Membership test on list literal with 4+ items - use set literal {...} for O(1) lookup"
metadata:
  weight: 2
  category: performance
rule:
  kind: comparison_operator
  pattern: $X in [$A, $B, $C, $D, $$$REST]
