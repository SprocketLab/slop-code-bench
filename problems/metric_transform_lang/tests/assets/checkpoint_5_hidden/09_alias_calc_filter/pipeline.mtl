mtl_version 1.5

schema BaseSale {
  timestamp: timestamp
  location: string
  item: string
  price: float
  quantity: float
}

schema WebSale extends BaseSale {
  unit: string
  category: string
}

pipeline AliasFiltered using WebSale {
  sources {
    web as W,
    pos as P
  }

  with W {
    calc markup = price * 0.05 : float @stage(pre)
    filter(price > 1.2)
  }

  with P {
    filter(quantity >= 4)
  }

  join W with P
    on (W.item == P.item & W.location == P.location)
    type inner
    project {
      W.timestamp as timestamp,
      W.location  as location,
      W.item      as item,
      P.quantity  as units,
      W.markup    as markup_fee
    }

  window(1h)
  group_by(['location','item'])
  aggregate sum(units) as total_units,
            sum(markup_fee) as total_markup
}
