{
    "empty_pipeline_no_steps": {
        "stdin": {
            "pipeline": {
                "steps": []
            },
            "dataset": [
                {
                    "id": 1
                }
            ],
            "metadata": {
                "note": "ignored"
            }
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": []
            }
        }
    },
    "rename_multiple_mapping": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {
                            "first_name": "first",
                            "last_name": "last",
                            "postal": "zip_code"
                        },
                        "note": "drop me"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {
                            "first_name": "first",
                            "last_name": "last",
                            "postal": "zip_code"
                        }
                    }
                ]
            }
        }
    },
    "trimmed_ops_and_exprs": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": " FILTER ",
                        "where": " flag || ( price >= 10 ) "
                    },
                    {
                        "op": " MAP ",
                        "as": " status ",
                        "expr": " flag ",
                        "extra": "ignored"
                    }
                ]
            },
            "dataset": [],
            "extra_top_level": true
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "filter",
                        "where": "flag || ( price >= 10 )"
                    },
                    {
                        "op": "map",
                        "as": "status",
                        "expr": "flag"
                    }
                ]
            }
        }
    },
    "limit_zero_passthrough": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "value"
                        ]
                    },
                    {
                        "op": "limit",
                        "n": 0
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 10
                }
            ]
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "value"
                        ]
                    },
                    {
                        "op": "limit",
                        "n": 0
                    }
                ]
            }
        }
    },
    "rename_from_to_canonical": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": " ReName ",
                        "from": "price",
                        "to": "usd_price"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "USD"
                        ]
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {
                            "price": "usd_price"
                        }
                    },
                    {
                        "op": "select",
                        "columns": [
                            "USD"
                        ]
                    }
                ]
            }
        }
    },
    "full_pipeline_all_ops": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": " Select ",
                        "columns": [
                            "id",
                            "price",
                            "qty"
                        ],
                        "note": "ignored"
                    },
                    {
                        "op": " MAP ",
                        "as": " total ",
                        "expr": " price * qty ",
                        "extra": "drop"
                    },
                    {
                        "op": " FiLtEr ",
                        "where": " total >= 20 "
                    },
                    {
                        "op": " rename ",
                        "from": " total ",
                        "to": " grand_total "
                    },
                    {
                        "op": " limit ",
                        "n": 5
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "price": 10,
                    "qty": 2
                }
            ]
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "price",
                            "qty"
                        ]
                    },
                    {
                        "op": "map",
                        "as": "total",
                        "expr": "price * qty"
                    },
                    {
                        "op": "filter",
                        "where": "total >= 20"
                    },
                    {
                        "op": "rename",
                        "mapping": {
                            "total": "grand_total"
                        }
                    },
                    {
                        "op": "limit",
                        "n": 5
                    }
                ]
            }
        }
    },
    "dataset_empty_array": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "sku",
                            "qty",
                            "price"
                        ]
                    },
                    {
                        "op": "map",
                        "as": "subtotal",
                        "expr": "qty * price"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "sku",
                            "qty",
                            "price"
                        ]
                    },
                    {
                        "op": "map",
                        "as": "subtotal",
                        "expr": "qty * price"
                    }
                ]
            }
        }
    },
    "map_and_filter_chain": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "map",
                        "as": "subtotal",
                        "expr": "price * qty"
                    },
                    {
                        "op": "map",
                        "as": "tax",
                        "expr": "subtotal * 0.08"
                    },
                    {
                        "op": "filter",
                        "where": "tax >= 1"
                    },
                    {
                        "op": "map",
                        "as": "total_with_tax",
                        "expr": "subtotal + tax"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "map",
                        "as": "subtotal",
                        "expr": "price * qty"
                    },
                    {
                        "op": "map",
                        "as": "tax",
                        "expr": "subtotal * 0.08"
                    },
                    {
                        "op": "filter",
                        "where": "tax >= 1"
                    },
                    {
                        "op": "map",
                        "as": "total_with_tax",
                        "expr": "subtotal + tax"
                    }
                ]
            }
        }
    },
    "rename_mixed_forms": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "RENAME",
                        "from": "amount",
                        "to": "price"
                    },
                    {
                        "op": "rename",
                        "mapping": {
                            "price": "final_price"
                        }
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "ok",
            "normalized": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {
                            "amount": "price"
                        }
                    },
                    {
                        "op": "rename",
                        "mapping": {
                            "price": "final_price"
                        }
                    }
                ]
            }
        }
    }
}
