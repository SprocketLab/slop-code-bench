{
    "empty_select_columns": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "select",
                        "columns": []
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].columns"
        }
    },
    "limit_n_not_integer": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "limit",
                        "n": "10"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].n"
        }
    },
    "unknown_op": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "TRANSPOSE"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "UNKNOWN_OP",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].op"
        }
    },
    "dataset_not_array": {
        "stdin": {
            "pipeline": {
                "steps": []
            },
            "dataset": {
                "id": 1
            }
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "dataset"
        }
    },
    "dataset_row_not_object": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "limit",
                        "n": 1
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1
                },
                "oops"
            ]
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "dataset[1]"
        }
    },
    "rename_missing_column_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {
                            "cost": "price"
                        }
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "price": 10
                }
            ]
        },
        "expected": {
            "status": "error",
            "error_code": "MISSING_COLUMN",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].mapping.cost"
        }
    },
    "select_missing_after_filter": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "filter",
                        "where": "qty > 1"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "missing"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "qty": 2
                },
                {
                    "id": 2,
                    "qty": 0
                }
            ]
        },
        "expected": {
            "status": "error",
            "error_code": "MISSING_COLUMN",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[1].columns[1]"
        }
    },
    "bad_expr_in_second_step": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "map",
                        "as": "total",
                        "expr": "price * qty"
                    },
                    {
                        "op": "map",
                        "as": "bad",
                        "expr": "total ^^ 2"
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "price": 5,
                    "qty": 2
                }
            ]
        },
        "expected": {
            "status": "error",
            "error_code": "BAD_EXPR",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[1].expr"
        }
    },
    "select_duplicate_columns_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "id"
                        ]
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].columns"
        }
    },
    "filter_empty_where_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "filter",
                        "where": "   "
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].where"
        }
    },
    "map_missing_as_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "map",
                        "expr": "price * 2"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].as"
        }
    },
    "rename_mapping_empty_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {}
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].mapping"
        }
    },
    "limit_negative_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "limit",
                        "n": -1
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].n"
        }
    },
    "pipeline_steps_not_array_error": {
        "stdin": {
            "pipeline": {
                "steps": {
                    "op": "select",
                    "columns": [
                        "id"
                    ]
                }
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "SCHEMA_VALIDATION_FAILED",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps"
        }
    },
    "unknown_op_error": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "aggregate"
                    }
                ]
            },
            "dataset": []
        },
        "expected": {
            "status": "error",
            "error_code": "UNKNOWN_OP",
            "message": "ETL_ERROR:.*",
            "path": "pipeline.steps[0].op"
        }
    }
}