{
    "unused_def_ignored": {
        "stdin": {
            "defs": {
                "Normalize": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "centered",
                            "expr": "value - params.mean"
                        }
                    ]
                },
                "Broken": {
                    "steps": [
                        {
                            "op": "unknown_op"
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": "Normalize",
                        "params": {
                            "mean": 10
                        }
                    },
                    {
                        "op": "map",
                        "as": "tag",
                        "expr": "\"done\""
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "centered",
                            "tag"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 15
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "centered": 5,
                    "tag": "done"
                }
            ],
            "metrics": {
                "rows_in": 1,
                "rows_out": 1
            }
        }
    },
    "nested_call_chain": {
        "stdin": {
            "defs": {
                "Scale": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "scaled",
                            "expr": "value * params.factor"
                        }
                    ]
                },
                "Bump": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "bumped",
                            "expr": "scaled + params.delta"
                        }
                    ]
                },
                "Pipeline": {
                    "steps": [
                        {
                            "op": "call",
                            "name": "Scale",
                            "params": {
                                "factor": 2
                            }
                        },
                        {
                            "op": "call",
                            "name": "Bump",
                            "params": {
                                "delta": 3
                            }
                        },
                        {
                            "op": "select",
                            "columns": [
                                "id",
                                "scaled",
                                "bumped"
                            ]
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": "Pipeline",
                        "params": {}
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 5
                },
                {
                    "id": 2,
                    "value": -1
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "scaled": 10,
                    "bumped": 13
                },
                {
                    "id": 2,
                    "scaled": -2,
                    "bumped": 1
                }
            ],
            "metrics": {
                "rows_in": 2,
                "rows_out": 2
            }
        }
    },
    "branch_call_labeling": {
        "stdin": {
            "defs": {
                "Label": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "label",
                            "expr": "params.code"
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "branch",
                        "branches": [
                            {
                                "id": "vip",
                                "when": "score >= 90",
                                "steps": [
                                    {
                                        "op": "call",
                                        "name": "Label",
                                        "params": {
                                            "code": "vip"
                                        }
                                    }
                                ]
                            },
                            {
                                "id": "otherwise",
                                "when": "otherwise",
                                "steps": [
                                    {
                                        "op": "call",
                                        "name": "Label",
                                        "params": {
                                            "code": "std"
                                        }
                                    }
                                ]
                            }
                        ],
                        "merge": {
                            "strategy": "concat"
                        }
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "label"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "score": 95
                },
                {
                    "id": 2,
                    "score": 70
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "label": "vip"
                },
                {
                    "id": 2,
                    "label": "std"
                }
            ],
            "metrics": {
                "rows_in": 2,
                "rows_out": 2
            }
        }
    },
    "call_trimmed_name_case_sensitive": {
        "stdin": {
            "defs": {
                "MixedCase": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "tag",
                            "expr": "\"ok\""
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": " MixedCase ",
                        "params": {}
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "tag": "ok"
                }
            ],
            "metrics": {
                "rows_in": 1,
                "rows_out": 1
            }
        }
    },
    "call_missing_param_null": {
        "stdin": {
            "defs": {
                "Z": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "z",
                            "expr": "(value - params.mean) / params.std"
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": "Z",
                        "params": {
                            "mean": 10
                        }
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 15
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "value": 15,
                    "z": null
                }
            ],
            "metrics": {
                "rows_in": 1,
                "rows_out": 1
            }
        }
    },
    "call_with_array_params": {
        "stdin": {
            "defs": {
                "Annotate": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "labels",
                            "expr": "params.labels"
                        }
                    ]
                },
                "Keep": {
                    "steps": [
                        {
                            "op": "select",
                            "columns": [
                                "id",
                                "labels"
                            ]
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": "Annotate",
                        "params": {
                            "labels": [
                                "vip",
                                "promo"
                            ]
                        }
                    },
                    {
                        "op": "call",
                        "name": "Keep",
                        "params": {}
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "labels": [
                        "vip",
                        "promo"
                    ]
                }
            ],
            "metrics": {
                "rows_in": 1,
                "rows_out": 1
            }
        }
    },
    "call_branch_router_success": {
        "stdin": {
            "defs": {
                "Route": {
                    "steps": [
                        {
                            "op": "branch",
                            "branches": [
                                {
                                    "id": "high",
                                    "when": "value >= params.cutoff",
                                    "steps": [
                                        {
                                            "op": "map",
                                            "as": "bucket",
                                            "expr": "\"high\""
                                        }
                                    ]
                                },
                                {
                                    "id": "otherwise",
                                    "when": "otherwise",
                                    "steps": [
                                        {
                                            "op": "map",
                                            "as": "bucket",
                                            "expr": "\"low\""
                                        }
                                    ]
                                }
                            ],
                            "merge": {
                                "strategy": "concat"
                            }
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": "Route",
                        "params": {
                            "cutoff": 50
                        }
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "bucket"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 70
                },
                {
                    "id": 2,
                    "value": 45
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "bucket": "high"
                },
                {
                    "id": 2,
                    "bucket": "low"
                }
            ],
            "metrics": {
                "rows_in": 2,
                "rows_out": 2
            }
        }
    },
    "call_sequential_defs": {
        "stdin": {
            "defs": {
                "Scale": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "scaled",
                            "expr": "value * params.factor"
                        }
                    ]
                },
                "Offset": {
                    "steps": [
                        {
                            "op": "map",
                            "as": "adjusted",
                            "expr": "scaled + params.delta"
                        }
                    ]
                }
            },
            "pipeline": {
                "steps": [
                    {
                        "op": "call",
                        "name": "Scale",
                        "params": {
                            "factor": 3
                        }
                    },
                    {
                        "op": "call",
                        "name": "Offset",
                        "params": {
                            "delta": -1
                        }
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "scaled",
                            "adjusted"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 2
                },
                {
                    "id": 2,
                    "value": 10
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "scaled": 6,
                    "adjusted": 5
                },
                {
                    "id": 2,
                    "scaled": 30,
                    "adjusted": 29
                }
            ],
            "metrics": {
                "rows_in": 2,
                "rows_out": 2
            }
        }
    }
}