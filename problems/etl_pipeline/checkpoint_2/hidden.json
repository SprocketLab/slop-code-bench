{
    "map_null_propagation": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "map",
                        "as": "gross",
                        "expr": "price * qty"
                    },
                    {
                        "op": "map",
                        "as": "net",
                        "expr": "gross - discount"
                    },
                    {
                        "op": "rename",
                        "mapping": {
                            "net": "final_total"
                        }
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "price": 25,
                    "qty": 2,
                    "discount": 5
                },
                {
                    "id": 2,
                    "price": 8,
                    "qty": null,
                    "discount": 3
                },
                {
                    "id": 3,
                    "price": 5,
                    "qty": 0
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "price": 25,
                    "qty": 2,
                    "discount": 5,
                    "gross": 50,
                    "final_total": 45
                },
                {
                    "id": 2,
                    "price": 8,
                    "qty": null,
                    "discount": 3,
                    "gross": null,
                    "final_total": null
                },
                {
                    "id": 3,
                    "price": 5,
                    "qty": 0,
                    "gross": 0,
                    "final_total": null
                }
            ],
            "metrics": {
                "rows_in": 3,
                "rows_out": 3
            }
        }
    },
    "filter_short_circuit": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "filter",
                        "where": "flag || (qty >= 10)"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "flag",
                            "qty"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "flag": false,
                    "qty": 12
                },
                {
                    "id": 2,
                    "flag": true,
                    "qty": 1
                },
                {
                    "id": 3,
                    "flag": null,
                    "qty": 15
                },
                {
                    "id": 4,
                    "flag": false,
                    "qty": 3
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "flag": false,
                    "qty": 12
                },
                {
                    "id": 2,
                    "flag": true,
                    "qty": 1
                },
                {
                    "id": 3,
                    "flag": null,
                    "qty": 15
                }
            ],
            "metrics": {
                "rows_in": 4,
                "rows_out": 3
            }
        }
    },
    "rename_select_collision": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "rename",
                        "mapping": {
                            "amount": "price",
                            "price": "original_price"
                        }
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "price",
                            "original_price"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "amount": 10,
                    "price": 7
                },
                {
                    "id": 2,
                    "amount": null,
                    "price": 9
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "price": 10,
                    "original_price": 7
                },
                {
                    "id": 2,
                    "price": null,
                    "original_price": 9
                }
            ],
            "metrics": {
                "rows_in": 2,
                "rows_out": 2
            }
        }
    },
    "filter_non_boolean_as_false": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "filter",
                        "where": "score"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "score"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "score": true
                },
                {
                    "id": 2,
                    "score": "yes"
                },
                {
                    "id": 3,
                    "score": false
                },
                {
                    "id": 4
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "score": true
                }
            ],
            "metrics": {
                "rows_in": 4,
                "rows_out": 1
            }
        }
    },
    "limit_zero_exec": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "value"
                        ]
                    },
                    {
                        "op": "limit",
                        "n": 0
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "value": 10
                },
                {
                    "id": 2,
                    "value": 20
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [],
            "metrics": {
                "rows_in": 2,
                "rows_out": 0
            }
        }
    },
    "map_divide_by_zero_null": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "map",
                        "as": "unit_price",
                        "expr": "total / qty"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "unit_price"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "total": 10,
                    "qty": 2
                },
                {
                    "id": 2,
                    "total": 5,
                    "qty": 0
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "unit_price": 5
                },
                {
                    "id": 2,
                    "unit_price": null
                }
            ],
            "metrics": {
                "rows_in": 2,
                "rows_out": 2
            }
        }
    },
    "logical_negation_truthiness": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "filter",
                        "where": "!flag"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "flag"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "flag": true
                },
                {
                    "id": 2,
                    "flag": false
                },
                {
                    "id": 3,
                    "flag": "yes"
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 2,
                    "flag": false
                },
                {
                    "id": 3,
                    "flag": "yes"
                }
            ],
            "metrics": {
                "rows_in": 3,
                "rows_out": 2
            }
        }
    },
    "complex_expression_success": {
        "stdin": {
            "pipeline": {
                "steps": [
                    {
                        "op": "map",
                        "as": "score",
                        "expr": "(a + b) / c"
                    },
                    {
                        "op": "filter",
                        "where": "(score >= 10) && (flag || (bonus > 0))"
                    },
                    {
                        "op": "select",
                        "columns": [
                            "id",
                            "score",
                            "flag",
                            "bonus"
                        ]
                    }
                ]
            },
            "dataset": [
                {
                    "id": 1,
                    "a": 10,
                    "b": 10,
                    "c": 2,
                    "flag": true,
                    "bonus": 0
                },
                {
                    "id": 2,
                    "a": 15,
                    "b": 5,
                    "c": 2,
                    "flag": false,
                    "bonus": 1
                },
                {
                    "id": 3,
                    "a": 6,
                    "b": 4,
                    "c": 2,
                    "flag": false,
                    "bonus": 0
                },
                {
                    "id": 4,
                    "a": 20,
                    "b": 10,
                    "c": 0,
                    "flag": true,
                    "bonus": 0
                }
            ]
        },
        "expected": {
            "status": "ok",
            "data": [
                {
                    "id": 1,
                    "score": 10,
                    "flag": true,
                    "bonus": 0
                },
                {
                    "id": 2,
                    "score": 10,
                    "flag": false,
                    "bonus": 1
                }
            ],
            "metrics": {
                "rows_in": 4,
                "rows_out": 2
            }
        }
    }
}