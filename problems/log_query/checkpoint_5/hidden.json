{
  "06_scalar_pocket_zero_rows_returns_null": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT b.status FROM b WHERE b.rid = UPTREE.a.req) AS status FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "req": "r1"},
            {"id": 2, "req": "r_nonexistent"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"rid": "r1", "status": 200}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "status": 200},
        {"a.id": 2, "status": null}
      ],
      "status_code": 0
    }
  },
  "07_beholds_exists_true": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE BEHOLDS POCKET[SELECT b.rid FROM b WHERE b.req = UPTREE.a.req]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "req": "r1"},
            {"id": 2, "req": "r2"},
            {"id": 3, "req": "r3"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"rid": "x1", "req": "r1"},
            {"rid": "x2", "req": "r2"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 2}
      ],
      "status_code": 0
    }
  },
  "08_beholds_exists_false": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE BEHOLDS POCKET[SELECT b.rid FROM b WHERE b.req = UPTREE.a.req]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "req": "r1"},
            {"id": 2, "req": "r_none"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"rid": "x1", "req": "r1"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "09_amongst_in_with_match": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.status AMONGST POCKET[SELECT b.allowed_status FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "status": 200},
            {"id": 2, "status": 404},
            {"id": 3, "status": 500}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"allowed_status": 200},
            {"allowed_status": 404}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 2}
      ],
      "status_code": 0
    }
  },
  "10_amongst_type_mismatch_no_match": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val AMONGST POCKET[SELECT b.val FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": 100},
            {"id": 2, "val": "200"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"val": "100"},
            {"val": 200}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [],
      "status_code": 0
    }
  },
  "11_amongst_with_null": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val AMONGST POCKET[SELECT b.val FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": null},
            {"id": 2, "val": 10}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"val": null},
            {"val": 20}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "12_amongst_with_arrays": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.tags AMONGST POCKET[SELECT b.tags FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "tags": ["x", "y"]},
            {"id": 2, "tags": ["a", "b"]}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"tags": ["x", "y"]},
            {"tags": ["c", "d"]}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "13_eitherwise_any_greater": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val > EITHERWISE POCKET[SELECT b.threshold FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": 15},
            {"id": 2, "val": 5},
            {"id": 3, "val": 25}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"threshold": 10},
            {"threshold": 20}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 3}
      ],
      "status_code": 0
    }
  },
  "14_eitherwise_any_empty_is_false": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val > EITHERWISE POCKET[SELECT b.threshold FROM b WHERE b.enabled = true]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": 100}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"threshold": 10, "enabled": false}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [],
      "status_code": 0
    }
  },
  "15_everywise_all_less_than": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val < EVERYWISE POCKET[SELECT b.limit FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": 5},
            {"id": 2, "val": 15},
            {"id": 3, "val": 25}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"limit": 10},
            {"limit": 20}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "16_everywise_all_empty_is_true": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val > EVERYWISE POCKET[SELECT b.min FROM b WHERE b.enabled = true]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": 1},
            {"id": 2, "val": 100}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"min": 50, "enabled": false}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 2}
      ],
      "status_code": 0
    }
  },
  "17_eitherwise_equals": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.status = EITHERWISE POCKET[SELECT b.ok_status FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "status": 200},
            {"id": 2, "status": 404},
            {"id": 3, "status": 201}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"ok_status": 200},
            {"ok_status": 201}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 3}
      ],
      "status_code": 0
    }
  },
  "18_everywise_not_equals": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.status != EVERYWISE POCKET[SELECT b.bad_status FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "status": 200},
            {"id": 2, "status": 500},
            {"id": 3, "status": 404}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"bad_status": 500},
            {"bad_status": 503}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 3}
      ],
      "status_code": 0
    }
  },
  "19_scalar_pocket_with_aggregate": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT COUNT(*) FROM b WHERE b.req = UPTREE.a.req) AS count FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "req": "r1"},
            {"id": 2, "req": "r2"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"req": "r1"},
            {"req": "r1"},
            {"req": "r2"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "count": 2},
        {"a.id": 2, "count": 1}
      ],
      "status_code": 0
    }
  },
  "20_scalar_pocket_with_sum": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT SUM(b.bytes) FROM b WHERE b.req = UPTREE.a.req) AS total FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "req": "r1"},
            {"id": 2, "req": "r2"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"req": "r1", "bytes": 100},
            {"req": "r1", "bytes": 200},
            {"req": "r2", "bytes": 50}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "total": 300},
        {"a.id": 2, "total": 50}
      ],
      "status_code": 0
    }
  },
  "21_uptree_with_dotted_path": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE BEHOLDS POCKET[SELECT b.rid FROM b WHERE b.status = UPTREE.a.http.status]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "http": {"status": 200}},
            {"id": 2, "http": {"status": 404}}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"rid": "r1", "status": 200}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "22_uptree_with_null": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT COUNT(*) FROM b WHERE b.val = UPTREE.a.val) AS cnt FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": null},
            {"id": 2, "val": 10}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"val": null},
            {"val": 10},
            {"val": 10}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "cnt": 1},
        {"a.id": 2, "cnt": 2}
      ],
      "status_code": 0
    }
  },
  "23_pocket_in_select_without_as": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT b.status FROM b WHERE b.req = UPTREE.a.req) FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "req": "r1"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"req": "r1", "status": 200}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "POCKET(SELECT b.status FROM b WHERE b.req = UPTREE.a.req)": 200}
      ],
      "status_code": 0
    }
  },
  "24_amongst_with_objects": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.meta AMONGST POCKET[SELECT b.config FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "meta": {"k": 1, "v": 2}},
            {"id": 2, "meta": {"k": 2}}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"config": {"v": 2, "k": 1}},
            {"config": {"k": 3}}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "25_eitherwise_string_comparison": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.level < EITHERWISE POCKET[SELECT b.level FROM b]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "level": "DEBUG"},
            {"id": 2, "level": "INFO"},
            {"id": 3, "level": "WARN"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"level": "ERROR"},
            {"level": "INFO"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 2}
      ],
      "status_code": 0
    }
  },
  "26_nested_pocket": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --source c=c.ndjson --query 'SELECT a.id FROM a WHERE BEHOLDS POCKET[SELECT b.rid FROM b WHERE b.status = UPTREE.a.target AND BEHOLDS POCKET[SELECT c.cid FROM c WHERE c.req = UPTREE.b.req]]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "target": 200},
            {"id": 2, "target": 404}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"rid": "r1", "status": 200, "req": "x1"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "c.ndjson",
          "content": [
            {"cid": "c1", "req": "x1"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1}
      ],
      "status_code": 0
    }
  },
  "27_scalar_pocket_returns_string": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT b.name FROM b WHERE b.id = UPTREE.a.bid) AS name FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "bid": 10},
            {"id": 2, "bid": 20}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"id": 10, "name": "Alice"},
            {"id": 20, "name": "Bob"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "name": "Alice"},
        {"a.id": 2, "name": "Bob"}
      ],
      "status_code": 0
    }
  },
  "28_scalar_pocket_returns_boolean": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id, POCKET(SELECT b.enabled FROM b WHERE b.service = UPTREE.a.service) AS enabled FROM a'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "service": "api"},
            {"id": 2, "service": "web"}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"service": "api", "enabled": true},
            {"service": "web", "enabled": false}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1, "enabled": true},
        {"a.id": 2, "enabled": false}
      ],
      "status_code": 0
    }
  },
  "29_amongst_empty_pocket": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.val AMONGST POCKET[SELECT b.val FROM b WHERE b.enabled = true]'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "val": 100}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"val": 100, "enabled": false}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [],
      "status_code": 0
    }
  },
  "30_complex_boolean_with_pocket": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query 'SELECT a.id FROM a WHERE a.status = 200 AND BEHOLDS POCKET[SELECT b.rid FROM b WHERE b.req = UPTREE.a.req] OR a.priority = 1'",
      "input_files": [
        {
          "path": "a.ndjson",
          "content": [
            {"id": 1, "status": 200, "req": "r1", "priority": 0},
            {"id": 2, "status": 200, "req": "r_none", "priority": 0},
            {"id": 3, "status": 404, "req": "r1", "priority": 1}
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {"rid": "x1", "req": "r1"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a.id": 1},
        {"a.id": 3}
      ],
      "status_code": 0
    }
  }
}
