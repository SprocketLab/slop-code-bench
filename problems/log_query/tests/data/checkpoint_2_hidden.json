{
  "06_sum_with_negatives_and_nulls": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT SUM(n) AS total FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"n": 100},
            {"n": -50},
            {"n": null},
            {"n": 25},
            {"n": "10"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"total": 75}],
      "status_code": 0
    }
  },
  "07_avg_ignores_non_numbers": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT AVG(val) AS avg_val FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"val": 10},
            {"val": 20},
            {"val": "30"},
            {"val": null},
            {"val": 30}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"avg_val": 20}],
      "status_code": 0
    }
  },
  "09_min_prefers_numbers_over_strings": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT MIN(x) AS min_x, MAX(x) AS max_x FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 100},
            {"x": "50"},
            {"x": 200},
            {"x": "10"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"min_x": 100, "max_x": 200}],
      "status_code": 0
    }
  },
  "10_min_max_all_null_result": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT MIN(x) AS min_x, MAX(x) AS max_x FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": null},
            {"x": true},
            {"x": false},
            {}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"min_x": null, "max_x": null}],
      "status_code": 0
    }
  },
  "11_unique_with_duplicates": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(color) AS colors FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"color": "red"},
            {"color": "blue"},
            {"color": "red"},
            {"color": "green"},
            {"color": "blue"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"colors": ["red", "blue", "green"]}],
      "status_code": 0
    }
  },
  "12_unique_with_null": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(x) AS vals FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 1},
            {"x": null},
            {"x": 2},
            {"x": null},
            {"x": 1}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"vals": [1, null, 2]}],
      "status_code": 0
    }
  },
  "13_unique_with_arrays": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(tags) AS all_tags FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"tags": ["a", "b"]},
            {"tags": ["c"]},
            {"tags": ["a", "b"]},
            {"tags": null}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"all_tags": [["a", "b"], ["c"], null]}],
      "status_code": 0
    }
  },
  "14_unique_with_objects_key_order_ignored": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(meta) AS metas FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"meta": {"a": 1, "b": 2}},
            {"meta": {"b": 2, "a": 1}},
            {"meta": {"a": 1, "c": 3}}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"metas": [{"a": 1, "b": 2}, {"a": 1, "c": 3}]}],
      "status_code": 0
    }
  },
  "15_group_by_multiple_fields": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT level, service, COUNT(*) AS n FROM logs GROUP BY level, service'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"level": "INFO", "service": "api"},
            {"level": "ERROR", "service": "api"},
            {"level": "INFO", "service": "web"},
            {"level": "INFO", "service": "api"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"level": "INFO", "service": "api", "n": 2},
        {"level": "ERROR", "service": "api", "n": 1},
        {"level": "INFO", "service": "web", "n": 1}
      ],
      "status_code": 0
    }
  },
  "16_group_by_with_null_key": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT service, COUNT(*) AS n FROM logs GROUP BY service'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"service": "api"},
            {"service": null},
            {"service": "api"},
            {}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"service": "api", "n": 2},
        {"service": null, "n": 2}
      ],
      "status_code": 0
    }
  },
  "17_group_by_boolean_key": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT enabled, COUNT(*) AS n FROM logs GROUP BY enabled'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"enabled": true},
            {"enabled": false},
            {"enabled": true},
            {"enabled": null}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"enabled": true, "n": 2},
        {"enabled": false, "n": 1},
        {"enabled": null, "n": 1}
      ],
      "status_code": 0
    }
  },
  "18_group_by_array_becomes_null": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT tags, COUNT(*) AS n FROM logs GROUP BY tags'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"tags": ["a", "b"]},
            {"tags": ["c"]},
            {"tags": null},
            {}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"tags": null, "n": 4}
      ],
      "status_code": 0
    }
  },
  "19_group_by_object_becomes_null": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT meta, COUNT(*) AS n FROM logs GROUP BY meta'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"meta": {"k": 1}},
            {"meta": {"k": 2}},
            {"meta": null}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"meta": null, "n": 3}
      ],
      "status_code": 0
    }
  },
  "20_group_by_dotted_path": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT http.status, COUNT(*) AS n FROM logs GROUP BY http.status'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"http": {"status": 200}},
            {"http": {"status": 500}},
            {"http": {"status": 200}},
            {"http": null}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"http.status": 200, "n": 2},
        {"http.status": 500, "n": 1},
        {"http.status": null, "n": 1}
      ],
      "status_code": 0
    }
  },
  "21_count_star_vs_count_field": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT COUNT(*) AS all, COUNT(x) AS has_x FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 1},
            {"x": null},
            {},
            {"x": 0}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"all": 4, "has_x": 2}],
      "status_code": 0
    }
  },
  "22_count_field_counts_arrays_and_objects": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT COUNT(arr) AS c_arr, COUNT(obj) AS c_obj FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"arr": [], "obj": {}},
            {"arr": [1], "obj": {"k": "v"}},
            {"arr": null, "obj": null}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"c_arr": 2, "c_obj": 2}],
      "status_code": 0
    }
  },
  "24_avg_with_decimals": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT AVG(x) AS avg FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 1.5},
            {"x": 2.5},
            {"x": 3.0}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"avg": 2.3333333333333335}],
      "status_code": 0
    }
  },
  "25_group_by_with_where": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT service, COUNT(*) AS n FROM logs WHERE level = \\\"INFO\\\" GROUP BY service\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"level": "INFO", "service": "api"},
            {"level": "ERROR", "service": "api"},
            {"level": "INFO", "service": "web"},
            {"level": "INFO", "service": "api"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"service": "api", "n": 2},
        {"service": "web", "n": 1}
      ],
      "status_code": 0
    }
  },
  "26_aggregate_with_as_alias": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT COUNT(*) AS total, SUM(bytes) AS sum, AVG(bytes) AS average FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"bytes": 100},
            {"bytes": 200},
            {"bytes": 300}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"total": 3, "sum": 600, "average": 200}],
      "status_code": 0
    }
  },
  "27_aggregate_without_as_alias": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT COUNT(*), SUM(bytes), AVG(bytes) FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"bytes": 100},
            {"bytes": 200}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"COUNT(*)": 2, "SUM(bytes)": 300, "AVG(bytes)": 150}],
      "status_code": 0
    }
  },
  "28_avg_keyword_case_insensitive": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT avg(x) AS a1, AVG(x) AS a2, AvG(x) AS a3 FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 10},
            {"x": 20}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"a1": 15, "a2": 15, "a3": 15}],
      "status_code": 0
    }
  },
  "29_average_synonym_for_avg": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT AVERAGE(x) AS avg FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 10},
            {"x": 30}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"avg": 20}],
      "status_code": 0
    }
  },
  "30_average_canonical_name_is_avg": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT AVERAGE(x) FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 5}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"AVG(x)": 5}],
      "status_code": 0
    }
  },
  "31_unique_preserves_first_object_key_order": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(obj) AS objs FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"obj": {"z": 1, "a": 2}},
            {"obj": {"a": 2, "z": 1}},
            {"obj": {"b": 3}}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"objs": [{"z": 1, "a": 2}, {"b": 3}]}],
      "status_code": 0
    }
  },
  "32_group_by_first_seen_order": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT x, COUNT(*) AS n FROM logs GROUP BY x'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 3},
            {"x": 1},
            {"x": 2},
            {"x": 1},
            {"x": 3}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"x": 3, "n": 2},
        {"x": 1, "n": 2},
        {"x": 2, "n": 1}
      ],
      "status_code": 0
    }
  },
  "33_unique_first_seen_order_within_group": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(v) AS vals FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"v": "c"},
            {"v": "a"},
            {"v": "b"},
            {"v": "a"},
            {"v": "c"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"vals": ["c", "a", "b"]}],
      "status_code": 0
    }
  },
  "34_multiple_aggregates_per_group": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT service, COUNT(*) AS n, SUM(bytes) AS total, MIN(bytes) AS min_b, MAX(bytes) AS max_b FROM logs GROUP BY service'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"service": "api", "bytes": 100},
            {"service": "api", "bytes": 200},
            {"service": "web", "bytes": 50}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"service": "api", "n": 2, "total": 300, "min_b": 100, "max_b": 200},
        {"service": "web", "n": 1, "total": 50, "min_b": 50, "max_b": 50}
      ],
      "status_code": 0
    }
  },
  "35_group_by_with_zero_values": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT x, SUM(y) AS total FROM logs GROUP BY x'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 1, "y": 0},
            {"x": 1, "y": 10},
            {"x": 2, "y": 0}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"x": 1, "total": 10},
        {"x": 2, "total": 0}
      ],
      "status_code": 0
    }
  },
  "36_group_by_negative_numbers": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT x, COUNT(*) AS n FROM logs GROUP BY x'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": -1},
            {"x": 0},
            {"x": -1},
            {"x": 1}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"x": -1, "n": 2},
        {"x": 0, "n": 1},
        {"x": 1, "n": 1}
      ],
      "status_code": 0
    }
  },
  "37_empty_result_after_where": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT service, COUNT(*) AS n FROM logs WHERE level = \\\"FATAL\\\" GROUP BY service\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"level": "INFO", "service": "api"},
            {"level": "ERROR", "service": "web"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [],
      "status_code": 0
    }
  },
  "38_global_aggregate_with_where": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT COUNT(*) AS n, SUM(x) AS total FROM logs WHERE x > 0'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": -10},
            {"x": 5},
            {"x": 10},
            {"x": 0}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"n": 2, "total": 15}],
      "status_code": 0
    }
  },
  "40_field_with_as_in_select": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT service AS svc, COUNT(*) AS n FROM logs GROUP BY service'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"service": "api"},
            {"service": "web"},
            {"service": "api"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"svc": "api", "n": 2},
        {"svc": "web", "n": 1}
      ],
      "status_code": 0
    }
  },
  "41_min_max_with_negative_decimals": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT MIN(x) AS min_x, MAX(x) AS max_x FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": -1.5},
            {"x": -2.5},
            {"x": 0.5},
            {"x": -0.5}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"min_x": -2.5, "max_x": 0.5}],
      "status_code": 0
    }
  },
  "42_unique_mixed_types": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(v) AS vals FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"v": 1},
            {"v": "1"},
            {"v": true},
            {"v": 1},
            {"v": null}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"vals": [1, "1", true, null]}],
      "status_code": 0
    }
  },
  "43_group_by_three_fields": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT a, b, c, COUNT(*) AS n FROM logs GROUP BY a, b, c'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"a": 1, "b": 2, "c": 3},
            {"a": 1, "b": 2, "c": 4},
            {"a": 1, "b": 2, "c": 3}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"a": 1, "b": 2, "c": 3, "n": 2},
        {"a": 1, "b": 2, "c": 4, "n": 1}
      ],
      "status_code": 0
    }
  },
  "44_sum_with_only_zero": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT SUM(x) AS total FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 0},
            {"x": 0},
            {"x": 0}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"total": 0}],
      "status_code": 0
    }
  },
  "45_count_star_on_empty": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT COUNT(*) AS n FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"n": 0}],
      "status_code": 0
    }
  },
  "46_unique_empty_arrays_equal": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(arr) AS arrs FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"arr": []},
            {"arr": []},
            {"arr": [1]}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"arrs": [[], [1]]}],
      "status_code": 0
    }
  },
  "47_unique_empty_objects_equal": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT UNIQUE(obj) AS objs FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"obj": {}},
            {"obj": {}},
            {"obj": {"k": "v"}}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"objs": [{}, {"k": "v"}]}],
      "status_code": 0
    }
  },
  "48_group_by_string_values": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT method, COUNT(*) AS n FROM logs GROUP BY method'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"method": "GET"},
            {"method": "POST"},
            {"method": "GET"},
            {"method": "DELETE"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {"method": "GET", "n": 2},
        {"method": "POST", "n": 1},
        {"method": "DELETE", "n": 1}
      ],
      "status_code": 0
    }
  },
  "49_avg_single_value": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT AVG(x) AS avg FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"x": 42}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"avg": 42}],
      "status_code": 0
    }
  },
  "50_min_max_single_string": {
    "case": {
      "arguments": "--log-file logs.ndjson --query 'SELECT MIN(s) AS min_s, MAX(s) AS max_s FROM logs'",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {"s": "only"}
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [{"min_s": "only", "max_s": "only"}],
      "status_code": 0
    }
  }
}
