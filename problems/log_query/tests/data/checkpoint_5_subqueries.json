{
  "01_scalar_pocket_count": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --source c=c.ndjson --source d=d.ndjson --query \"SELECT a.id, POCKET(SELECT COUNT(*) FROM b WHERE b.rid = UPTREE.a.req) AS b_count FROM a\"",
      "input_files": [
        {
          "path": "d.ndjson",
          "content": [
            {
              "user": "u1",
              "tags": [
                "x",
                "y"
              ]
            },
            {
              "user": "u3",
              "tags": [
                "y"
              ]
            },
            {
              "user": "u5",
              "tags": [
                "x"
              ]
            }
          ],
          "file_type": "jsonl"
        },
        {
          "path": "b.ndjson",
          "content": [
            {
              "rid": "r1",
              "host": "h1",
              "status": 200,
              "p95": 12
            },
            {
              "rid": "r1",
              "host": "h2",
              "status": 500,
              "p95": 18
            },
            {
              "rid": "r2",
              "host": "h3",
              "status": 404,
              "p95": 25
            },
            {
              "rid": "r2",
              "host": "h3",
              "status": 503,
              "p95": 35
            },
            {
              "rid": "r3",
              "host": "h4",
              "status": 200,
              "p95": 40
            },
            {
              "rid": "rX",
              "host": "h9",
              "status": 200,
              "p95": 5
            }
          ],
          "file_type": "jsonl"
        },
        {
          "path": "a.ndjson",
          "content": [
            {
              "id": 1,
              "req": "r1",
              "bytes": 100,
              "route": "/a",
              "latency_ms": 10,
              "user": "u1",
              "tags": [
                "x",
                "y"
              ]
            },
            {
              "id": 2,
              "req": "r2",
              "bytes": null,
              "route": "/b",
              "latency_ms": 20,
              "user": "u2",
              "tags": [
                "x",
                "y"
              ]
            },
            {
              "id": 3,
              "req": "r3",
              "bytes": 50,
              "route": "/a",
              "latency_ms": 30,
              "user": "u3",
              "tags": null
            },
            {
              "id": 4,
              "req": "rX",
              "bytes": 0,
              "route": "/c",
              "latency_ms": 15,
              "user": "u4",
              "tags": [
                "y"
              ]
            }
          ],
          "file_type": "jsonl"
        },
        {
          "path": "c.ndjson",
          "content": [
            {
              "route": "/a",
              "slo_ms": 20,
              "limit": 120
            },
            {
              "route": "/b",
              "slo_ms": 15,
              "limit": 60
            },
            {
              "route": "/a",
              "slo_ms": 25,
              "limit": 80
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "a.id": 1,
          "b_count": 2
        },
        {
          "a.id": 2,
          "b_count": 2
        },
        {
          "a.id": 3,
          "b_count": 1
        },
        {
          "a.id": 4,
          "b_count": 1
        }
      ],
      "status_code": 0
    }
  },
  "02_scalar_pocket_zero_rows": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query \"SELECT POCKET(SELECT b.rid FROM b WHERE b.rid = \\\"none\\\") AS rid FROM a WHERE a.id = 1\"",
      "input_files": [
        {
          "path": "b.ndjson",
          "content": [
            {
              "rid": "r1"
            }
          ],
          "file_type": "jsonl"
        },
        {
          "path": "a.ndjson",
          "content": [
            {
              "id": 1,
              "req": "r1"
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "rid": null
        }
      ],
      "status_code": 0
    }
  },
  "03_any_eitherwise_lt": {
    "case": {
      "arguments": "--source a=a.ndjson --source b=b.ndjson --query \"SELECT a.id FROM a WHERE a.latency_ms < EITHERWISE POCKET[SELECT b.p95 FROM b WHERE b.rid = UPTREE.a.req]\"",
      "input_files": [
        {
          "path": "b.ndjson",
          "content": [
            {
              "rid": "r1",
              "p95": 12
            },
            {
              "rid": "r1",
              "p95": 18
            },
            {
              "rid": "r2",
              "p95": 25
            },
            {
              "rid": "r2",
              "p95": 35
            },
            {
              "rid": "r3",
              "p95": 40
            }
          ],
          "file_type": "jsonl"
        },
        {
          "path": "a.ndjson",
          "content": [
            {
              "id": 1,
              "req": "r1",
              "latency_ms": 10
            },
            {
              "id": 2,
              "req": "r2",
              "latency_ms": 20
            },
            {
              "id": 3,
              "req": "r3",
              "latency_ms": 30
            },
            {
              "id": 4,
              "req": "rX",
              "latency_ms": 15
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "a.id": 1
        },
        {
          "a.id": 2
        },
        {
          "a.id": 3
        }
      ],
      "status_code": 0
    }
  }
}
