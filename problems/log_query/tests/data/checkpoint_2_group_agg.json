{
  "01_global_aggregates": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT COUNT(*) AS total, SUM(bytes) AS sum_bytes, AVG(latency_ms) AS avg_latency FROM logs WHERE level = \\\"INFO\\\"\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {
              "level": "INFO",
              "service": "api",
              "bytes": 100,
              "latency_ms": 10,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "ERROR",
              "service": "api",
              "bytes": null,
              "latency_ms": "11",
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "web",
              "bytes": 250,
              "latency_ms": 5,
              "route": "/b",
              "host": "h1"
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": -50,
              "latency_ms": 7.5,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "WARN",
              "service": "worker",
              "bytes": 0,
              "latency_ms": null,
              "route": "/c",
              "host": "h3",
              "meta": {
                "tags": [
                  "x"
                ]
              }
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": "300",
              "latency_ms": 9,
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "api",
              "route": "/a",
              "host": "h1",
              "obj": {
                "k": 1
              },
              "arr": [
                1,
                2
              ]
            },
            {
              "level": "INFO",
              "service": null,
              "bytes": 500,
              "latency_ms": 12,
              "route": "/b",
              "host": "h4"
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "total": 6,
          "sum_bytes": 800,
          "avg_latency": 8.7
        }
      ],
      "status_code": 0
    }
  },
  "02_group_by_selected_keys": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT service, COUNT(*) AS n FROM logs WHERE bytes >= 0 GROUP BY service\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {
              "level": "INFO",
              "service": "api",
              "bytes": 100,
              "latency_ms": 10,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "ERROR",
              "service": "api",
              "bytes": null,
              "latency_ms": "11",
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "web",
              "bytes": 250,
              "latency_ms": 5,
              "route": "/b",
              "host": "h1"
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": -50,
              "latency_ms": 7.5,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "WARN",
              "service": "worker",
              "bytes": 0,
              "latency_ms": null,
              "route": "/c",
              "host": "h3",
              "meta": {
                "tags": [
                  "x"
                ]
              }
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": "300",
              "latency_ms": 9,
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "api",
              "route": "/a",
              "host": "h1",
              "obj": {
                "k": 1
              },
              "arr": [
                1,
                2
              ]
            },
            {
              "level": "INFO",
              "service": null,
              "bytes": 500,
              "latency_ms": 12,
              "route": "/b",
              "host": "h4"
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "service": "api",
          "n": 1
        },
        {
          "service": "web",
          "n": 1
        },
        {
          "service": "worker",
          "n": 1
        },
        {
          "service": null,
          "n": 1
        }
      ],
      "status_code": 0
    }
  },
  "03_count_field_arrays_objects": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT route, COUNT(bytes) AS has_bytes, COUNT(arr) AS has_arr, COUNT(obj) AS has_obj FROM logs GROUP BY route\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {
              "level": "INFO",
              "service": "api",
              "bytes": 100,
              "latency_ms": 10,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "ERROR",
              "service": "api",
              "bytes": null,
              "latency_ms": "11",
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "web",
              "bytes": 250,
              "latency_ms": 5,
              "route": "/b",
              "host": "h1"
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": -50,
              "latency_ms": 7.5,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "WARN",
              "service": "worker",
              "bytes": 0,
              "latency_ms": null,
              "route": "/c",
              "host": "h3",
              "meta": {
                "tags": [
                  "x"
                ]
              }
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": "300",
              "latency_ms": 9,
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "api",
              "route": "/a",
              "host": "h1",
              "obj": {
                "k": 1
              },
              "arr": [
                1,
                2
              ]
            },
            {
              "level": "INFO",
              "service": null,
              "bytes": 500,
              "latency_ms": 12,
              "route": "/b",
              "host": "h4"
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "route": "/a",
          "has_bytes": 3,
          "has_arr": 1,
          "has_obj": 1
        },
        {
          "route": "/b",
          "has_bytes": 2,
          "has_arr": 0,
          "has_obj": 0
        },
        {
          "route": "/c",
          "has_bytes": 1,
          "has_arr": 0,
          "has_obj": 0
        }
      ],
      "status_code": 0
    }
  },
  "04_min_max_modes": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT service, MIN(latency_ms) AS min_lat, MAX(latency_ms) AS max_lat FROM logs GROUP BY service\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {
              "level": "INFO",
              "service": "api",
              "bytes": 100,
              "latency_ms": 10,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "ERROR",
              "service": "api",
              "bytes": null,
              "latency_ms": "11",
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "web",
              "bytes": 250,
              "latency_ms": 5,
              "route": "/b",
              "host": "h1"
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": -50,
              "latency_ms": 7.5,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "WARN",
              "service": "worker",
              "bytes": 0,
              "latency_ms": null,
              "route": "/c",
              "host": "h3",
              "meta": {
                "tags": [
                  "x"
                ]
              }
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": "300",
              "latency_ms": 9,
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "api",
              "route": "/a",
              "host": "h1",
              "obj": {
                "k": 1
              },
              "arr": [
                1,
                2
              ]
            },
            {
              "level": "INFO",
              "service": null,
              "bytes": 500,
              "latency_ms": 12,
              "route": "/b",
              "host": "h4"
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "service": "api",
          "min_lat": 7.5,
          "max_lat": 10
        },
        {
          "service": "web",
          "min_lat": 5,
          "max_lat": 5
        },
        {
          "service": "worker",
          "min_lat": null,
          "max_lat": null
        },
        {
          "service": null,
          "min_lat": 12,
          "max_lat": 12
        }
      ],
      "status_code": 0
    }
  },
  "05_unique_hosts": {
    "case": {
      "arguments": "--log-file logs.ndjson --query \"SELECT route, UNIQUE(host) AS hosts FROM logs GROUP BY route\"",
      "input_files": [
        {
          "path": "logs.ndjson",
          "content": [
            {
              "level": "INFO",
              "service": "api",
              "bytes": 100,
              "latency_ms": 10,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "ERROR",
              "service": "api",
              "bytes": null,
              "latency_ms": "11",
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "web",
              "bytes": 250,
              "latency_ms": 5,
              "route": "/b",
              "host": "h1"
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": -50,
              "latency_ms": 7.5,
              "route": "/a",
              "host": "h1"
            },
            {
              "level": "WARN",
              "service": "worker",
              "bytes": 0,
              "latency_ms": null,
              "route": "/c",
              "host": "h3",
              "meta": {
                "tags": [
                  "x"
                ]
              }
            },
            {
              "level": "INFO",
              "service": "api",
              "bytes": "300",
              "latency_ms": 9,
              "route": "/a",
              "host": "h2"
            },
            {
              "level": "INFO",
              "service": "api",
              "route": "/a",
              "host": "h1",
              "obj": {
                "k": 1
              },
              "arr": [
                1,
                2
              ]
            },
            {
              "level": "INFO",
              "service": null,
              "bytes": 500,
              "latency_ms": 12,
              "route": "/b",
              "host": "h4"
            }
          ],
          "file_type": "jsonl"
        }
      ]
    },
    "expected": {
      "output": [
        {
          "route": "/a",
          "hosts": [
            "h1",
            "h2"
          ]
        },
        {
          "route": "/b",
          "hosts": [
            "h1",
            "h4"
          ]
        },
        {
          "route": "/c",
          "hosts": [
            "h3"
          ]
        }
      ],
      "status_code": 0
    }
  }
}