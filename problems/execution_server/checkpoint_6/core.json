{
  "create_environment_never": {
    "expected": {
      "output": {
        "concurrency_mode": "never",
        "files": {
          "config.txt": {
            "written_bytes": 13
          }
        },
        "name": "test-never"
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "concurrency_mode": "never",
        "files": {
          "config.txt": "initial state"
        },
        "name": "test-never"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/environment"
    },
    "order": 0
  },
  "create_environment_fork": {
    "expected": {
      "output": {
        "concurrency_mode": "fork",
        "files": {
          "counter.txt": {
            "written_bytes": 1
          }
        },
        "name": "test-fork"
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "concurrency_mode": "fork",
        "files": {
          "counter.txt": "0"
        },
        "name": "test-fork"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/environment"
    },
    "order": 1
  },
  "create_environment_base": {
    "expected": {
      "output": {
        "name": "test-base",
        "concurrency_mode": "base",
        "files": {
          "base.txt": {
            "written_bytes": 12
          }
        }
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "concurrency_mode": "base",
        "files": {
          "base.txt": "base content"
        },
        "name": "test-base"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/environment"
    },
    "order": 2
  },
  "execute_never_mode": {
    "expected": {
      "output": {
        "cached": false,
        "duration": 10,
        "environment": {
          "committed": true,
          "name": "test-never",
          "snapshot_source": "exclusive"
        },
        "exit_code": 0,
        "files": {
          "config.txt": "initial state",
          "output.txt": "modified\n"
        },
        "id": "UUID",
        "stderr": "",
        "stdout": "",
        "timed_out": false
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "command": "echo 'modified' > output.txt",
        "environment": "test-never",
        "track": [
          "*.txt"
        ]
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 3
  },
  "execute_fork_mode": {
    "expected": {
      "output": {
        "cached": false,
        "duration": 10,
        "environment": {
          "committed": true,
          "name": "test-fork",
          "snapshot_source": "exclusive"
        },
        "exit_code": 0,
        "files": {
          "counter.txt": "1\n"
        },
        "id": "UUID",
        "stderr": "",
        "stdout": "",
        "timed_out": false
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "command": "echo '1' > counter.txt",
        "environment": "test-fork",
        "track": [
          "*.txt"
        ]
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 4
  },
  "execute_base_mode": {
    "expected": {
      "output": {
        "cached": false,
        "duration": 10,
        "environment": {
          "committed": true,
          "name": "test-base",
          "snapshot_source": "base"
        },
        "exit_code": 0,
        "files": {
          "base.txt": "base content",
          "modified.txt": "change\n"
        },
        "id": "UUID",
        "stderr": "",
        "stdout": "",
        "timed_out": false
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "command": "echo 'change' > modified.txt",
        "environment": "test-base",
        "track": [
          "*.txt"
        ]
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 5
  },
  "execute_base_mode_isolated": {
    "expected": {
      "output": {
        "cached": false,
        "duration": 10,
        "environment": {
          "committed": true,
          "name": "test-base",
          "snapshot_source": "base"
        },
        "exit_code": 0,
        "files": {
          "base.txt": "base content"
        },
        "id": "UUID",
        "stderr": "",
        "stdout": "base content",
        "timed_out": false
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "command": "cat base.txt",
        "environment": "test-base",
        "track": [
          "*.txt"
        ]
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 6
  },
  "missing_environment_field": {
    "expected": {
      "output": {
        "type": "object",
        "properties": {
          "code": {
            "const": "MISSING_ENVIRONMENT"
          },
          "error": {
            "type": "string"
          }
        },
        "required": [
          "code",
          "error"
        ]
      },
      "status_code": 400
    },
    "input": {
      "body": {
        "command": "echo hello"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 7
  },
  "unknown_environment": {
    "expected": {
      "output": {
        "type": "object",
        "properties": {
          "code": {
            "const": "ENVIRONMENT_NOT_FOUND"
          },
          "error": {
            "type": "string"
          }
        },
        "required": [
          "code",
          "error"
        ]
      },
      "status_code": 404
    },
    "input": {
      "body": {
        "command": "echo hello",
        "environment": "nonexistent"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 8
  },
  "verify_never_persistence": {
    "expected": {
      "output": {
        "cached": false,
        "duration": 10,
        "environment": {
          "committed": true,
          "name": "test-never",
          "snapshot_source": "exclusive"
        },
        "exit_code": 0,
        "files": {
          "config.txt": "initial state",
          "output.txt": "modified\n"
        },
        "id": "UUID",
        "stderr": "",
        "stdout": "2\n",
        "timed_out": false
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "command": "ls -1 | wc -l",
        "environment": "test-never",
        "track": [
          "*.txt"
        ]
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 9
  },
  "create_duplicate_environment": {
    "expected": {
      "output": {
        "type": "object",
        "properties": {
          "code": {
            "const": "ENVIRONMENT_EXISTS"
          },
          "error": {
            "type": "string"
          }
        },
        "required": [
          "code",
          "error"
        ]
      },
      "status_code": 404
    },
    "input": {
      "body": {
        "files": {
          "test.txt": "content"
        },
        "name": "test-never"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/environment"
    },
    "order": 10
  },
  "environment_with_overlay_files": {
    "expected": {
      "output": {
        "cached": false,
        "duration": 10,
        "environment": {
          "committed": true,
          "name": "test-never",
          "snapshot_source": "exclusive"
        },
        "exit_code": 0,
        "files": {
          "output.txt": "modified\n",
          "config.txt": "initial state",
          "overlay.txt": "overlay content\n"
        },
        "id": "UUID",
        "stderr": "",
        "stdout": "overlay content\n",
        "timed_out": false
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "command": "cat overlay.txt",
        "environment": "test-never",
        "files": {
          "overlay.txt": "overlay content\n"
        },
        "track": [
          "*.txt"
        ]
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/execute"
    },
    "order": 11
  },
  "create_environment_default_mode": {
    "expected": {
      "output": {
        "concurrency_mode": "never",
        "files": {
          "default.txt": {
            "written_bytes": 17
          }
        },
        "name": "test-default"
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "files": {
          "default.txt": "default mode test"
        },
        "name": "test-default"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/environment"
    },
    "order": 12
  },
  "create_environment_no_files": {
    "expected": {
      "output": {
        "concurrency_mode": "never",
        "files": {},
        "name": "test-empty"
      },
      "status_code": 201
    },
    "input": {
      "body": {
        "name": "test-empty"
      },
      "headers": {
        "content-type": "application/json; charset=utf-8"
      },
      "method": "POST",
      "path": "/v1/environment"
    },
    "order": 13
  }
}